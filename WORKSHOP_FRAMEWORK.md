# AION2 工坊经济模块框架（备忘）

更新时间: 2026-02-15

## 目标
- 在现有桌面程序内新增“工坊”业务域，不破坏角色管理主链路。
- 以本地数据为中心，先完成 MVP，再逐步扩展行情抓取与分析能力。

## 业务分层
- 数据层:
  - 角色主数据继续走 `aion2-dashboard`。
  - 工坊数据独立存储 `aion2-dashboard-workshop`。
- 领域层:
  - 配方展开与材料需求计算。
  - 税后利润与机会成本估算。
  - 库存可制作能力反推。
- 接入层:
  - `shared/ipc.ts` 新增 `workshop:*` IPC 通道。
  - `preload` 暴露统一 API。
- UI 层:
  - 顶部页签新增“工坊”。
  - Phase 1 提供录入与模拟闭环。

## 数据模型（Phase 1）
- `items`: 物品主数据（名称、分类、备注）。
- `recipes`: 配方（成品、产量、材料列表）。
- `prices`: 价格快照（物品、单价、时间、来源）。
- `inventory`: 当前库存（物品、数量）。

## 计算规则（Phase 1）
- 套娃配方展开:
  - 从目标配方递归展开到“无子配方物品”作为底层材料。
  - 子配方按 `ceil(需求量 / 产量)` 计算制作次数。
  - 检测循环配方并报错。
- 成本:
  - 材料总成本 = 底层材料需求量 * 最新单价（若价格齐全）。
  - 缺口补齐成本 = max(需求-库存, 0) * 最新单价。
- 利润:
  - 税后收入 = 成品单价 * 产量 * (1 - 税率)。
  - 估算利润 = 税后收入 - 材料总成本。
- 逆向推导:
  - 对每条配方计算单次需求。
  - 用库存计算可做次数并按收益排序。

## 阶段计划
- Phase 1（当前）:
  - 物品/价格/库存录入。
  - 配方录入。
  - 制作模拟器（税后利润 + 材料缺口）。
  - 背包可制作推荐。
- Phase 1.1（验证增强）:
  - 一键导入样例数据（`样例-*` 命名，避免污染真实数据）。
  - 导入后可立即在模拟器验证套娃成本、税后利润、缺口计算与可制作推荐是否正确。
- Phase 1.2（近可制作推荐）:
  - 支持“补差预算”输入。
  - 输出“差一点可做”的目标清单（单次补差成本、预算内可补差次数、预算内潜在利润）。
  - 支持排序策略切换：
    - 最高预算利润优先
    - 最低补差成本优先
- Phase 2:
  - Phase 2.1（已开工）:
    - 价格历史查询接口（按物品 + 时间范围/天数）。
    - 基础指标：MA7、按星期几均价。
    - 工坊页新增数据验证面板（无图表，先验证数据正确性）。
  - Phase 2.2:
    - 价格历史曲线（按物品）。
  - Phase 2.3:
    - 周期性波动提示（按星期）。
- Phase 3（已完成）:
  - 自动/半自动抓价管线（OCR 导入优先）。
  - 图标映射与缓存机制（显式 > 缓存 > 推断，含别名缓存）。
  - 行模板图标抓取（名称锚点左移固定窗口裁图，按行批量哈希）。
  - 全局快捷键抓价（自动截屏 -> OCR -> 导入）与可视化校准预览。
  - 调试增强：热键候选回退、快捷抓价告警明细、交易行 TSV 行对齐修复、价格字符混淆容错。
  - 结果可追踪：抓价明细（物品/价格/时间/是否新增）与最近抓价更新面板。
  - 防误新增默认策略：缺失物品自动创建默认关闭。
- Phase 4:
  - 趋势建议与“进货点/出货点”标注。

## 本次实现清单
- 新增 `src/main/workshop-store.ts` 工坊域存储与计算引擎。
- 新增 `workshop:*` IPC 与 preload API。
- 新增 `src/renderer/src/WorkshopView.tsx` Phase 1 操作面板。
- `App.tsx` 新增“工坊”入口页签。
- 新增 Phase 1.1 样例导入:
  - IPC: `workshop:seed-sample-data`
  - 后端: `seedWorkshopSampleData()`
  - 前端按钮: “一键导入样例”
- 新增 Phase 1.2 预算补差建议:
  - 前端模块基于现有 `getWorkshopCraftOptions` 二次计算“近可制作”清单。
  - 支持预算内潜在利润排序，辅助“补一点材料后制作出售”决策。
  - 新增排序策略切换控件，适配不同决策风格（收益优先/低门槛优先）。
- 新增 Phase 2.1 价格历史数据基础:
  - 新增类型:
    - `WorkshopPriceHistoryQuery`
    - `WorkshopPriceHistoryResult`
    - `WorkshopPriceHistoryPoint`
    - `WorkshopWeekdayAverage`
  - 新增 IPC:
    - `workshop:get-price-history`
  - 后端:
    - `getWorkshopPriceHistory()` 支持按 `days` 或 `fromAt/toAt` 查询。
    - 返回 MA7、区间均价、按星期几均价、最新价等指标。
  - 前端:
    - 工坊页新增“Phase 2.1 数据验证”面板用于即时校验结果。
