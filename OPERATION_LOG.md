# AION2 Dashboard - 操作日志

## 2026-02-09

### 今日完成
- 完成 Electron + React + Vite + TypeScript 基础框架搭建，形成可持续迭代结构。
- 实现本地持久化（`electron-store`）与 `main/preload/renderer/shared` 分层。
- 建立配置驱动任务模型（`TaskDefinition`），支持后续按配置扩展任务。
- 实现奥德能量双池模型：
  - 自然能量：`xx/840`（每 3 小时 +15，自然恢复）
  - 补充能量：`(+yyyy)`（当前上限已改为 `+2000`）
  - 扣减顺序：先扣基础，再扣补充
- 实现关键自动刷新规则：
  - 每日 05:00 刷新
  - 每周三 05:00 刷新
  - 远征次数时段补充（04:00 / 12:00 / 20:00）
  - 超越次数时段补充（03:00 / 15:00）
  - 恶梦每日 +2（上限 14）
- 完成打卡交互重构（移除 prompt 的不稳定方案）：
  - 任务完成次数（支持输入）
  - 吃券 +1
  - 录入已完成（用于指令书类）
  - 失败时弹窗内显示明确错误原因（例如奥德不足、次数不足）
- 角色管理功能：
  - 新增角色
  - 重命名角色
  - 删除角色（至少保留 1 个）
- 圣域逻辑重构：
  - 合并为单卡“圣域”
  - 分开管理：挑战次数（4）/ 开箱次数（2，40奥德）
  - 支持手动设定
- 远征/超越手动设定：
  - 基础次数
  - 券次数
  - 首领次数
  - 增加输入说明，避免误解字段含义
- 恶梦/觉醒/讨伐也已支持手动设定（基础次数 + 券次数）。
- 远征 84 次策略改为“警示”而非“硬拦截”：
  - 超过 84 后继续允许挑战
  - 提示奖励/金币会折扣

### 当前业务规则状态
- 远征/超越完成次数：逻辑正常，支持多次输入、能量校验、券扣减。
- 远征/超越扣减顺序：基础次数优先扣减，再扣券次数。
- 奥德不足时会给出明确错误提示（已验证）。

### 明日建议优先事项（Phase 3）
1. 增加“操作历史日志 + 撤销一步/多步”。
2. 增加“下一次恢复倒计时”模块（远征/超越/每日/每周重置）。
3. 增加“设置页”：
   - 金币收益参数
   - 次数上限参数（可选）
   - 提示阈值参数（如远征 84 门槛）
4. 增加“数据导出/导入”以便备份与迁移。

### 合作约定
- 后续每次迭代结束，同步更新本文件，确保连续协作不丢上下文。

## 2026-02-10

### 今日完成（Phase 3）
- 增加“操作历史日志 + 撤销一步/多步”：
  - 新增全局操作日志持久化（记录动作、时间、角色、描述、撤销快照）。
  - 绝大多数状态变更都纳入日志（角色管理、任务打卡、手动设定、设置修改、周统计重置、导入）。
  - 新增撤销 API，支持一次撤销 1 步或 N 步。
- 增加“下一次恢复倒计时”模块：
  - 远征恢复倒计时。
  - 超越恢复倒计时。
  - 每日重置倒计时（05:00）。
  - 每周重置倒计时（周三 05:00）。
- 增加“设置页”模块（内嵌在主界面）：
  - 金币收益参数（远征/超越）。
  - 次数上限参数（可选，留空使用默认；用于次数设定与刷新钳制）。
  - 提示阈值参数（远征阈值、超越阈值；远征默认 84）。
- 增加“数据导出/导入”：
  - 导出 JSON 备份（系统保存对话框）。
  - 导入 JSON 备份（系统打开对话框）。
  - 导入后自动写入一条可撤销日志，支持一键回滚导入。

### 结构改动
- `src/shared/types.ts`
  - 扩展 `AppSettings`（金币/上限/阈值）。
  - 增加 `OperationLogEntry`、`AppStateSnapshot`。
  - 扩展 `AppState`（新增 `history`）。
  - 增加导入导出结果类型。
- `src/main/store.ts`
  - 引入统一状态变更提交入口（自动写操作日志）。
  - 新增 `undoOperations` / `updateSettings` / `exportDataToFile` / `importDataFromFile`。
  - 导入导出使用 Electron 文件对话框 + 本地 JSON 文件。
- `src/main/ipc.ts` / `src/shared/ipc.ts` / `src/preload/index.ts`
  - 新增 IPC：撤销、更新设置、导出、导入。
- `src/shared/time.ts`
  - 新增 next tick/reset 计算函数，供倒计时模块使用。
- `src/shared/engine.ts`
  - 任务进度显示支持读取设置中的可选次数上限。
- `src/renderer/src/App.tsx`
  - 新增倒计时卡片、操作历史列表、撤销入口、设置参数面板、导入导出按钮。
  - 远征预警阈值改为可配置读取。

### 校验
- 已执行 `npm run typecheck`，通过。

### 当日追加修正（按最新反馈校准）
- 远征/超越恢复时段整体后移 1 小时以匹配你实测：
  - 远征改为 `05:00 / 13:00 / 21:00`
  - 超越改为 `04:00 / 16:00`
- 设置页从“仪表盘内嵌模块”改为“独立 Tab 页面”。
- 新增“清空历史日志”按钮（与撤销入口并列）。
- 每日副本补齐：
  - 支持吃券（券库存录入）
  - 支持手动设定（基础次数 + 券库存）
- 升级状态版本到 `v4`，增加旧数据兼容迁移：
  - 将旧模型里“已包含券的每日副本剩余次数”自动还原为“基础次数”，避免升级后双重计数。
- 所有支持吃券的任务改为“输入数字批量录入”，不再固定 `+1`。
- 圣域“手动设定”弹窗增加字段说明（挑战剩余/开箱剩余含义与上限）。

### 当日二次追加（深渊回廊 + 金币单位）
- 金币展示与设置输入统一改为“万”为单位（内部仍按原始金币值存储）。
- 仪表盘倒计时新增“深渊回廊刷新”。
- “神器”文案统一改为“深渊回廊”。
- 深渊回廊改为全局同步模型：
  - 用户手动设定“本轮可打数量 + 下次时间（默认当前+48小时）”后，自动同步到所有角色。
  - 每个角色仅需录入“本角色完成了几个”，系统自动扣减该角色回廊剩余。
- 远征/超越恢复时段维持本次校准值：
  - 远征 `05:00 / 13:00 / 21:00`
  - 超越 `04:00 / 16:00`

### 当日三次追加（回廊交互修复）
- 修复“同步回廊（全角色）/回廊录入完成”点击反馈不明显问题：
  - 从 `prompt` 交互改为可见弹窗交互。
  - 增加设置页中的“深渊回廊参数（全局同步）”可视化表单，支持直接填写数量、下次时间、当前角色完成次数。
- 保留角色面板上的两个快捷按钮，但改为打开弹窗，不再“无感”。

### 当日四次追加（回廊双层化）
- 深渊回廊拆分为“下层回廊 / 中层回廊”两条独立通道：
  - 可打数量独立（各 0-3）
  - 刷新时间独立
- 回廊时间输入改为“倒计时托选”，不再输入日期：
  - 小时 `0-48`
  - 分钟 `0-60`
- 倒计时展示按 48 小时上限显示（回廊卡片展示固定为“上限 48 小时倒计时”说明）。
- 每角色录入完成时，可选择“下层 or 中层”并分别扣减该角色对应剩余次数。
- 状态版本升级到 `v5`，兼容读取旧字段 `artifactAvailable/artifactNextAt`（自动映射到下层回廊）。

### 当日五次追加（多账号 + 回廊隔离 + 新任务）
- 增加账号管理：
  - 支持新增/重命名/删除/切换账号。
  - 单账号最多 8 个角色（前后端双重校验）。
  - 新账号自动创建默认角色，避免账号空角色导致操作断链。
- 左侧角色管理重构为“账号 -> 角色”分层，新增角色默认进入当前账号。
- 深渊回廊同步从“全角色”改为“当前账号角色”：
  - 账号之间回廊数据互不影响。
  - 相关 IPC / preload / store / UI 全链路已对齐。
- 新增任务卡片：
  - 小游戏：`14/14`，每日 `+2`（05:00），支持券。
  - 精灵入侵：`7/7`，每日 `+1`（05:00），不支持券。
- 扩展手动设定：
  - 小游戏支持“基础次数 + 券次数”手动录入。
  - 保持每日副本/恶梦/觉醒/讨伐/远征/超越等手动设定一致性。
- 撤销能力补齐：
  - 撤销时同步恢复 `selectedAccountId` 与 `accounts` 快照，保证多账号状态回退一致。

### 当日六次追加（时段校准 + 任务卡片清理）
- 超越恢复时段按实测校准为：`05:00 / 17:00`。
- 周收益统计保留“每周三 05:00 自动重置”逻辑，并在 UI 增加显式提示。
- 使命类卡片简化：
  - 删除不可用占位按钮（如“不适用”）。
  - “录入已完成”文案统一为“输入已完成次数”。
- 任务分组和文案调整：
  - 每日副本归类到“周常任务”。
  - 吃券相关文案统一为“挑战券增加次数”。
  - 圣域并入“副本任务”区域，位于远征/超越之后一行。

### 当日七次追加（Dashboard 双层工作流）
- 新增 Dashboard 双模式：
  - 角色总览（默认进入）：先看全局可打情况。
  - 角色操作：点角色后进入沉浸式打卡与记录。
- 总览面板改造为“战前看板”：
  - 按账号分组展示角色卡片。
  - 所有核心项目统一为 `当前/总量` 形式（如 `每日副本 7/7`）。
  - 增加颜色分级：
    - 0 次：灰色
    - 低量：黄色
    - 高量：青色
  - 点击角色卡直接进入对应角色操作视图，形成“先总览 -> 再沉浸记录”的链路。
