# AION2 Dashboard - 操作日志

## 2026-02-09

### 今日完成
- 完成 Electron + React + Vite + TypeScript 基础框架搭建，形成可持续迭代结构。
- 实现本地持久化（`electron-store`）与 `main/preload/renderer/shared` 分层。
- 建立配置驱动任务模型（`TaskDefinition`），支持后续按配置扩展任务。
- 实现奥德能量双池模型：
  - 自然能量：`xx/840`（每 3 小时 +15，自然恢复）
  - 补充能量：`(+yyyy)`（当前上限已改为 `+2000`）
  - 扣减顺序：先扣基础，再扣补充
- 实现关键自动刷新规则：
  - 每日 05:00 刷新
  - 每周三 05:00 刷新
  - 远征次数时段补充（04:00 / 12:00 / 20:00）
  - 超越次数时段补充（03:00 / 15:00）
  - 恶梦每日 +2（上限 14）
- 完成打卡交互重构（移除 prompt 的不稳定方案）：
  - 任务完成次数（支持输入）
  - 吃券 +1
  - 录入已完成（用于指令书类）
  - 失败时弹窗内显示明确错误原因（例如奥德不足、次数不足）
- 角色管理功能：
  - 新增角色
  - 重命名角色
  - 删除角色（至少保留 1 个）
- 圣域逻辑重构：
  - 合并为单卡“圣域”
  - 分开管理：挑战次数（4）/ 开箱次数（2，40奥德）
  - 支持手动设定
- 远征/超越手动设定：
  - 基础次数
  - 券次数
  - 首领次数
  - 增加输入说明，避免误解字段含义
- 恶梦/觉醒/讨伐也已支持手动设定（基础次数 + 券次数）。
- 远征 84 次策略改为“警示”而非“硬拦截”：
  - 超过 84 后继续允许挑战
  - 提示奖励/金币会折扣

### 当前业务规则状态
- 远征/超越完成次数：逻辑正常，支持多次输入、能量校验、券扣减。
- 远征/超越扣减顺序：基础次数优先扣减，再扣券次数。
- 奥德不足时会给出明确错误提示（已验证）。

### 明日建议优先事项（Phase 3）
1. 增加“操作历史日志 + 撤销一步/多步”。
2. 增加“下一次恢复倒计时”模块（远征/超越/每日/每周重置）。
3. 增加“设置页”：
   - 金币收益参数
   - 次数上限参数（可选）
   - 提示阈值参数（如远征 84 门槛）
4. 增加“数据导出/导入”以便备份与迁移。

### 合作约定
- 后续每次迭代结束，同步更新本文件，确保连续协作不丢上下文。

## 2026-02-10

### 今日完成（Phase 3）
- 增加“操作历史日志 + 撤销一步/多步”：
  - 新增全局操作日志持久化（记录动作、时间、角色、描述、撤销快照）。
  - 绝大多数状态变更都纳入日志（角色管理、任务打卡、手动设定、设置修改、周统计重置、导入）。
  - 新增撤销 API，支持一次撤销 1 步或 N 步。
- 增加“下一次恢复倒计时”模块：
  - 远征恢复倒计时。
  - 超越恢复倒计时。
  - 每日重置倒计时（05:00）。
  - 每周重置倒计时（周三 05:00）。
- 增加“设置页”模块（内嵌在主界面）：
  - 金币收益参数（远征/超越）。
  - 次数上限参数（可选，留空使用默认；用于次数设定与刷新钳制）。
  - 提示阈值参数（远征阈值、超越阈值；远征默认 84）。
- 增加“数据导出/导入”：
  - 导出 JSON 备份（系统保存对话框）。
  - 导入 JSON 备份（系统打开对话框）。
  - 导入后自动写入一条可撤销日志，支持一键回滚导入。

### 结构改动
- `src/shared/types.ts`
  - 扩展 `AppSettings`（金币/上限/阈值）。
  - 增加 `OperationLogEntry`、`AppStateSnapshot`。
  - 扩展 `AppState`（新增 `history`）。
  - 增加导入导出结果类型。
- `src/main/store.ts`
  - 引入统一状态变更提交入口（自动写操作日志）。
  - 新增 `undoOperations` / `updateSettings` / `exportDataToFile` / `importDataFromFile`。
  - 导入导出使用 Electron 文件对话框 + 本地 JSON 文件。
- `src/main/ipc.ts` / `src/shared/ipc.ts` / `src/preload/index.ts`
  - 新增 IPC：撤销、更新设置、导出、导入。
- `src/shared/time.ts`
  - 新增 next tick/reset 计算函数，供倒计时模块使用。
- `src/shared/engine.ts`
  - 任务进度显示支持读取设置中的可选次数上限。
- `src/renderer/src/App.tsx`
  - 新增倒计时卡片、操作历史列表、撤销入口、设置参数面板、导入导出按钮。
  - 远征预警阈值改为可配置读取。

### 校验
- 已执行 `npm run typecheck`，通过。

### 2026-02-12（续：微风商店/变换逻辑修正）
- 按最新规则修正：
  - 微风商店：仅记录 `奥德购买`、`每日副本挑战券购买` 两项（每项角色 5，账号额外角色 +8）。
  - 变换：仅记录 `奥德能量变换` 一项（角色 5，账号额外角色 +8）。
  - 删除“变换-副本券”相关字段与 UI。
- 角色操作页拆分为两个独立卡片：
  - `微风商店记录`（两项输入 + 保存 + 额外资格开关）
  - `变换记录`（仅奥德输入 + 保存）
- 总览徽标同步为三项：
  - `商店-奥德`、`商店-副本券`、`变换-奥德`。
- 数据结构与接口同步裁剪：
  - `aodePlan` 仅保留三项：`shopAodePurchaseUsed`、`shopDailyDungeonTicketPurchaseUsed`、`transformAodeUsed`。
  - `character:update-aode-plan` payload 同步去掉 `transformDailyDungeonTicketUsed`。

### 本次校验
- 已执行 `npm run typecheck`，通过。

### 2026-02-12（续：需求定稿与修正）
- 右侧倒计时展示修正：
  - “每周重置”从小时制改为天级展示：`X天X小时X分X秒`。
  - “回廊统一刷新”同样采用天级展示，并显示目标时间点。
- 深渊回廊刷新规则调整：
  - 上层/下层统一为 `今晚 21:00` 起每 `48` 小时刷新。
  - 设置页与同步弹窗改为仅录入“下层/中层当前可打数量”，不再录入小时/分钟倒计时。
- 角色新增“奥德购买/变换记录”：
  - 每角色基础上限：购买 `5`、变换 `5`。
  - 每账号可指定 1 个“额外角色”：购买 `+8`、变换 `+8`。
  - 角色操作页新增独立卡片：支持手动录入已用次数、显示剩余次数、一键设为/取消额外角色。
  - 总览卡片新增奥德进度展示：购买 `used/limit`、变换 `used/limit`。
  - 周重置时自动清零奥德购买/变换周计数。
- 数据结构与接口：
  - `AccountState` 新增 `extraAodeCharacterId`。
  - `CharacterState` 新增 `aodePlan.weeklyPurchaseUsed / weeklyConvertUsed`。
  - 新增 IPC：`character:update-aode-plan`，并完成 `main/preload/renderer` 全链路接入。
- 状态版本说明修订：
  - 当前 `APP_STATE_VERSION = 7` 用于本次“奥德计划 + 回廊统一刷新”模型；
  - 先前日志中关于 `v7` 与“开始本轮/作战笔记”的描述已不再作为当前实现依据。

### 本次校验
- 已执行 `npm run typecheck`，通过。

### 2026-02-12（续：倒计时样式与微风商店重构）
- 倒计时展示统一：
  - “每周重置”改回 `HH:MM:SS` 风格（与远征/超越一致）。
  - “回廊刷新”同样使用 `HH:MM:SS` 风格。
  - 文案从“回廊统一刷新”改为“回廊刷新”。
- “同步深渊回廊”弹窗精简：
  - 删除说明文案“刷新时间已统一为今晚21:00起每48小时自动推算”。
- 奥德模块重构为“微风商店 + 变换”四项记录（保留每账号 1 个额外角色 +8 机制）：
  - 微风商店：`奥德购买`、`每日副本挑战券购买`
  - 变换：`奥德`、`每日副本挑战券`
  - 四项均按“基础每角色 5 次，额外角色每项 +8 次”校验。
  - 总览卡新增四个进度徽标：商店-奥德、商店-副本券、变换-奥德、变换-副本券。
- 数据结构兼容升级：
  - `aodePlan` 字段从两项扩展为四项：
    - `shopAodePurchaseUsed`
    - `shopDailyDungeonTicketPurchaseUsed`
    - `transformAodeUsed`
    - `transformDailyDungeonTicketUsed`
  - 兼容旧存档：旧字段 `weeklyPurchaseUsed/weeklyConvertUsed` 自动迁移到新结构对应项。
- IPC 与 store 更新：
  - `character:update-aode-plan` payload 扩展为四项计数 + `assignExtra`。
  - 周重置时清空四项周计数。

### 本次校验
- 已执行 `npm run typecheck`，通过。

### 当日微调（总览标签字号）
- 角色总览卡中各项 `当前/总量` 标签（如“每日副本 7/7”）字号小幅上调：
  - `text-[11px]` -> `text-xs`
  - 同步微调标签横向内边距，增强 2K 全屏可读性。

### 当日再调优（2K 全屏空隙与比例）
- 回退“整体容器限宽”方案，改为三栏全宽自适应，避免两侧大面积留白。
- 三栏轨道按大屏分级：
  - `xl`: `300 / 1fr / 340`
  - `2xl`: `340 / 1fr / 400`
- 改用“根字号随分辨率同比例放大”：
  - `>=1900px`: `html font-size = 17px`
  - `>=2500px`: `html font-size = 18px`
- 目的：中栏自适应不空、全屏下信息密度更舒适，保持三栏层级不变。

### 当日再修正（按反馈回撤总览快捷操作）
- 移除总览卡快捷按钮：`+远征券`、`远征-1`、`+超越券`、`超越-1`。
- 总览页保留单一入口“进入角色”，所有操作回归角色界面内处理。
- 保留已完成功能：总览排序/筛选、顶部导航精简、每日首次自动备份。

### 当日继续迭代（统一快速录入选项卡）
- 在“角色总览”顶部新增“快速录入”选项卡：
  - 可选择：角色、内容、动作、次数。
  - 支持动作：完成次数 / 挑战券增加 / 输入已完成（按任务能力自动切换）。
  - 点击“提交录入”后直接写入对应角色与任务进度，无需先进入角色页。
- 交互策略：
  - 不再在每个角色卡放快捷按钮，避免卡片过载。
  - 保留总览卡“进入角色”主路径，快速录入作为上方统一入口。

### 当日追加（周统计次数手动校准）
- 新增“当前角色周次数校准（远征/超越）”输入区：
  - 支持手动填写“远征已完成次数 / 超越已完成次数”并保存。
  - 目标：误清空周统计后，可回填游戏内真实已完成次数，避免统计长期失真。
- 新增 IPC + store 写入链路：
  - `character:update-weekly-completions`
  - 仅更新当前角色 `stats.completions.expedition/transcendence`，保留其余周统计字段不变。

### 当日追加（页面三栏布局重构）
- 主体从两栏改为三栏（`左 300 / 中主内容 / 右 340`，`xl` 断点启用）：
  - 左栏：账号与角色管理（保持原逻辑）。
  - 中栏：核心流程（总览、角色操作、任务打卡、设置）。
  - 右栏：次要与辅助（操作中心、倒计时、操作历史、待办提醒）。
- 信息分层优化：
  - 将“撤销/清空历史”控制从主内容区移入右栏。
  - 将“下一次恢复倒计时”和“操作历史日志”从中栏移入右栏，减少主流程纵向负担。
- 响应式调整：
  - 中栏关键卡片网格改为分级列数（2xl 扩展到 4 或 2 列），避免中等宽度挤压阅读。

### 当日追加（2K 全屏可读性优化）
- 中栏增加最大宽度并居中，限制超宽行长，降低“横向过长”阅读负担。
- 新增 `>=2200px` 的字体与控件微放大策略：
  - `text-xs / text-sm` 提升一档。
  - `pill-btn / task-btn` 字号与内边距同步增大。
  - 统计卡 `tile-k / tile-v` 略放大。

### 当日再调整（修复全屏三栏空隙过大）
- 将“中栏单独限宽”改为“整体三栏容器限宽”：
  - 三栏外层新增 `max-width` 并居中，避免 2K 全屏时两侧出现大块留白。
  - 中栏改为填满其列宽，不再单独居中限宽。
- 三栏轨道调整为：`300 / minmax(980, 1fr) / 340`，并将栏间距由 `gap-5` 收敛到 `gap-4`。

### 当日追加修订（按最新反馈精简 + 第 4/5 项启动）
- 精简顶部导航：
  - 删除“仪表盘”入口（避免重复）。
  - 导航顺序调整为：`角色总览 -> 角色操作 -> 设置页`。
- 回退“一键开打会话/作战笔记”方案：
  - 移除“开始本轮”按钮与相关数据结构、IPC、store 逻辑。
  - 回到“只保留进入角色路径”的简洁流程。
  - 状态版本回归 `v6`。
- 总览快捷操作（第 4 项）已落地：
  - 每个角色卡新增高频快捷按钮：`+远征券`、`远征-1`、`+超越券`、`超越-1`。
  - 可在总览直接完成部分高频动作，减少来回切换。
- 自动备份策略（第 5 项）已落地：
  - 每天首次读取状态时自动生成 1 份本地备份（无需手动弹窗）。
  - 备份目录：`文档/aion2-dashboard-auto-backups/`
  - 备份文件名：`aion2-dashboard-auto-时间戳.json`
  - 记录“当日已备份”元数据，确保同一天只自动备份一次。

### 本次校验
- 已执行 `npm run typecheck`，通过。

### 当日追加修正（按最新反馈校准）
- 远征/超越恢复时段整体后移 1 小时以匹配你实测：
  - 远征改为 `05:00 / 13:00 / 21:00`
  - 超越改为 `04:00 / 16:00`
- 设置页从“仪表盘内嵌模块”改为“独立 Tab 页面”。
- 新增“清空历史日志”按钮（与撤销入口并列）。
- 每日副本补齐：
  - 支持吃券（券库存录入）
  - 支持手动设定（基础次数 + 券库存）
- 升级状态版本到 `v4`，增加旧数据兼容迁移：
  - 将旧模型里“已包含券的每日副本剩余次数”自动还原为“基础次数”，避免升级后双重计数。
- 所有支持吃券的任务改为“输入数字批量录入”，不再固定 `+1`。
- 圣域“手动设定”弹窗增加字段说明（挑战剩余/开箱剩余含义与上限）。

### 当日二次追加（深渊回廊 + 金币单位）
- 金币展示与设置输入统一改为“万”为单位（内部仍按原始金币值存储）。
- 仪表盘倒计时新增“深渊回廊刷新”。
- “神器”文案统一改为“深渊回廊”。
- 深渊回廊改为全局同步模型：
  - 用户手动设定“本轮可打数量 + 下次时间（默认当前+48小时）”后，自动同步到所有角色。
  - 每个角色仅需录入“本角色完成了几个”，系统自动扣减该角色回廊剩余。
- 远征/超越恢复时段维持本次校准值：
  - 远征 `05:00 / 13:00 / 21:00`
  - 超越 `04:00 / 16:00`

### 当日三次追加（回廊交互修复）
- 修复“同步回廊（全角色）/回廊录入完成”点击反馈不明显问题：
  - 从 `prompt` 交互改为可见弹窗交互。
  - 增加设置页中的“深渊回廊参数（全局同步）”可视化表单，支持直接填写数量、下次时间、当前角色完成次数。
- 保留角色面板上的两个快捷按钮，但改为打开弹窗，不再“无感”。

### 当日四次追加（回廊双层化）
- 深渊回廊拆分为“下层回廊 / 中层回廊”两条独立通道：
  - 可打数量独立（各 0-3）
  - 刷新时间独立
- 回廊时间输入改为“倒计时托选”，不再输入日期：
  - 小时 `0-48`
  - 分钟 `0-60`
- 倒计时展示按 48 小时上限显示（回廊卡片展示固定为“上限 48 小时倒计时”说明）。
- 每角色录入完成时，可选择“下层 or 中层”并分别扣减该角色对应剩余次数。
- 状态版本升级到 `v5`，兼容读取旧字段 `artifactAvailable/artifactNextAt`（自动映射到下层回廊）。

### 当日五次追加（多账号 + 回廊隔离 + 新任务）
- 增加账号管理：
  - 支持新增/重命名/删除/切换账号。
  - 单账号最多 8 个角色（前后端双重校验）。
  - 新账号自动创建默认角色，避免账号空角色导致操作断链。
- 左侧角色管理重构为“账号 -> 角色”分层，新增角色默认进入当前账号。
- 深渊回廊同步从“全角色”改为“当前账号角色”：
  - 账号之间回廊数据互不影响。
  - 相关 IPC / preload / store / UI 全链路已对齐。
- 新增任务卡片：
  - 小游戏：`14/14`，每日 `+2`（05:00），支持券。
  - 精灵入侵：`7/7`，每日 `+1`（05:00），不支持券。
- 扩展手动设定：
  - 小游戏支持“基础次数 + 券次数”手动录入。
  - 保持每日副本/恶梦/觉醒/讨伐/远征/超越等手动设定一致性。
- 撤销能力补齐：
  - 撤销时同步恢复 `selectedAccountId` 与 `accounts` 快照，保证多账号状态回退一致。

### 当日六次追加（时段校准 + 任务卡片清理）
- 超越恢复时段按实测校准为：`05:00 / 17:00`。
- 周收益统计保留“每周三 05:00 自动重置”逻辑，并在 UI 增加显式提示。
- 使命类卡片简化：
  - 删除不可用占位按钮（如“不适用”）。
  - “录入已完成”文案统一为“输入已完成次数”。
- 任务分组和文案调整：
  - 每日副本归类到“周常任务”。
  - 吃券相关文案统一为“挑战券增加次数”。
  - 圣域并入“副本任务”区域，位于远征/超越之后一行。

### 当日七次追加（Dashboard 双层工作流）
- 新增 Dashboard 双模式：
  - 角色总览（默认进入）：先看全局可打情况。
  - 角色操作：点角色后进入沉浸式打卡与记录。
- 总览面板改造为“战前看板”：
  - 按账号分组展示角色卡片。
  - 所有核心项目统一为 `当前/总量` 形式（如 `每日副本 7/7`）。
  - 增加颜色分级：
    - 0 次：灰色
    - 低量：黄色
    - 高量：青色
  - 点击角色卡直接进入对应角色操作视图，形成“先总览 -> 再沉浸记录”的链路。

## 2026-02-12

### 今日完成（延续主链路，第 1 + 2 项）
- 总览看板新增排序/筛选：
  - 排序维度：可执行项 / 账号 / 大区。
  - 筛选维度：任务类型（全部/副本/周常/使命）、账号、大区（含“未设置大区”）。
  - 总览卡片改为统一列表展示，筛选结果为空时给出显式提示。
- 新增“一键开打会话”：
  - 在总览卡增加“开始本轮”按钮。
  - 一次点击完成：切换到目标角色 + 自动创建本轮笔记时间戳（持久化到角色数据）。
  - 角色操作页头部新增“本轮笔记起点”展示，确认会话已创建。

### 结构改动
- `src/shared/types.ts`
  - 新增 `BattleNote` 类型与 `CharacterState.battleNotes` 字段。
- `src/shared/constants.ts`
  - 状态版本升级到 `v7`。
  - 默认角色结构新增 `battleNotes: []`。
- `src/main/store.ts`
  - 新增 battle notes 归一化逻辑（兼容旧数据、限长、按时间排序）。
  - 新增 `startCharacterSession(characterId)` 状态操作。
- `src/shared/ipc.ts` / `src/main/ipc.ts` / `src/preload/index.ts`
  - 新增 IPC 通道：`character:start-session`。
- `src/renderer/src/App.tsx`
  - 总览筛选/排序控件接入。
  - 总览卡新增“进入角色 / 开始本轮”双操作。
  - 角色操作页显示最新本轮会话时间戳。

### 校验
- 已执行 `npm run typecheck`，通过。
